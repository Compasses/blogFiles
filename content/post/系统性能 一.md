+++
author = "author"
date = "2016-01-17T21:48:25+08:00"
description = "性能问题定位"
draft = false
keywords = ["linux", "performance"]
tags = ["performance", "linux"]
title = "系统性能 一"
topics = ["topic 1"]
type = "post"

+++

最近一直在做系统性能优化，包括性能问题定位，系统整体性能提升等。在性能测试环境上一边测试一边优化，从最开始的表象开始，修改代码和各种系统参数，然后就会出现新的表象，然后再修改代码和系统参数。性能测试涉及的节点很多，很多方面都有联动性，最后辛辛苦苦的搞了大半个月，确实有所进展但是总感觉缺少系统的方法。今天有幸看到这样的一篇文章[Linux Performance Analysis in 60,000 Milliseconds](http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html)，明确了在一个server上面，最开始你应该关注到什么。虽然里面的东西大家都有注意，但是可能还是不够全面。现在就结合这篇文章和自己的实践做下总结吧。
## uptime
首先出场的便是**uptime**这个命令：
```
root@ip-172-31-3-207:~# uptime
 02:15:06 up 48 days, 18:01,  3 users,  load average: 65.43, 17.08, 5.81
```
这个命令明确告诉我们当前系统的时间，启动运行了多长时间，用户的登录数，以及当前系统分别在 1，5，15分钟内的进程平均数量，这些进程数量表示运行中或者处于不可中断的状态。这个命令是非常high level的总结，说明总体的系统负载情况。

## dmesg|tail
个人比较喜欢这个dmesg命令，一般是内核的日志，会有一些重要的信息抛出。例如进程异常退出，因为内存耗尽或者进程crash。还会记录些命令操作的异常。值得好好利用的命令。

## vmstat 1
系统虚拟内存的统计信息，1表示没1秒输出一次。

```
root@cnpvgvb1od042:~/PCP# vmstat 2
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 9818904   1820 3563052    0    0     0     2    0    0  0  0 100  0  0
 1  0      0 9842332   1820 3563104    0    0     0    98 4195 6788 41  4 55  0  0
 0  0      0 9888940   1820 3563124    0    0     0     0 1886 3149 15  2 83  0  0
 5  0      0 9917440   1820 3563104    0    0     0     0 3549 6524 31  4 66  0  0
15  0      0 9961216   1820 3563156    0    0     0    34 6469 11150 70  8 22  0  0
 5  0      0 9998920   1820 3563236    0    0     0     0 4350 7398 49  5 45  0  0
 2  0      0 10038652   1820 3563260    0    0     0    58 2922 4788 28  3 69  0  0
 4  0      0 10070480   1820 3563244    0    0     0  1252 2305 4215 14  2 84  0  0
 1  0      0 10100696   1820 3563284    0    0     0     0 2683 4405 14  2 84  0  0
```
几个重要的列：
r: 正在运行或者等待运行的进程数。该数量不包含I/O的进程。CPU是否饱和，就看这个数量是否多余CPU核的数量。
free:剩余内存以kb为单位。
si，so：换入换出，如果这些值非0，那么说明内存不足。
us, sy, id, wa, st: 这几项表明当前CPU的繁忙程度。分别代表了用户时间，系统时间，空闲时间，wait IO时间和stolen time。需要注意的是system time也有IO处理的时间。如果比较高的系统时间占用说明内核处理IO不够高效。

## mpstat -P ALL 1
这个命令每个CPU的使用率情况，如果有单核CPU过载的情况，说明线程的任务分配有问题。需要做相应的调整。
```
02:28:54 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
02:28:56 PM  all   85.62    0.00    6.00    0.00    1.81    0.00    0.00    0.00    0.00    6.57
02:28:56 PM    0   85.00    0.00    7.50    0.50    0.50    0.00    0.00    0.00    0.00    6.50
02:28:56 PM    1   87.94    0.00    5.53    0.00    0.50    0.00    0.00    0.00    0.00    6.03
02:28:56 PM    2   77.50    0.00    8.00    0.00   10.50    0.00    0.00    0.00    0.00    4.00
02:28:56 PM    3   89.39    0.00    5.05    0.00    0.51    0.00    0.00    0.00    0.00    5.05
02:28:56 PM    4   87.00    0.00    5.50    0.00    0.50    0.00    0.00    0.00    0.00    7.00
02:28:56 PM    5   87.00    0.00    6.00    0.00    0.50    0.00    0.00    0.00    0.00    6.50
02:28:56 PM    6   84.16    0.00    5.45    0.00    0.99    0.00    0.00    0.00    0.00    9.41
02:28:56 PM    7   86.93    0.00    5.03    0.00    0.50    0.00    0.00    0.00    0.00    7.54
```
## pidstat 1
用这个命令可以观察到单个进程的运行情况。并且每个CPU会单独列出。
```
02:44:55 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
02:44:57 PM     0         3    0.00    0.50    0.00    0.50     0  ksoftirqd/0
02:44:57 PM     0      6775    1.00    1.50    0.00    2.50     1  pidstat
02:44:57 PM 65534      9303    0.50    0.50    0.00    1.00     3  nginx
02:44:57 PM 65534      9304    1.00    0.50    0.00    1.50     5  nginx
02:44:57 PM 65534      9305    0.50    0.50    0.00    1.00     0  nginx
02:44:57 PM 65534      9306    0.00    0.50    0.00    0.50     0  nginx
02:44:57 PM 65534      9307    1.00    0.00    0.00    1.00     5  nginx
02:44:57 PM 65534      9308    0.50    0.00    0.00    0.50     7  nginx
02:44:57 PM 65534      9309    0.50    0.50    0.00    1.00     0  nginx
02:44:57 PM 65534      9310    0.50    0.50    0.00    1.00     7  nginx
02:44:57 PM   101     11711   10.50    4.50    0.00   15.00     1  beam.smp
02:44:57 PM   101     11743   29.50   26.00    0.00   55.50     6  child_setup
02:44:57 PM   101     11744   27.50   24.50    0.00   52.00     2  child_setup
02:44:57 PM     0     12083    0.00    0.50    0.00    0.50     3  kworker/3:1
02:44:57 PM     0     13591    0.00    0.50    0.00    0.50     5  btrfs-endio-wri
02:44:57 PM     0     14886    0.50    0.00    0.00    0.50     5  sshd
02:44:57 PM     0     16455    0.00    0.50    0.00    0.50     7  python
02:44:57 PM     0     18623    2.50    6.50    0.00    9.00     4  docker
02:44:57 PM     0     18665    1.50    3.50    0.00    5.00     0  redis-server
02:44:57 PM     0     19366    2.00    1.50    0.00    3.50     3  beam.smp
02:44:57 PM     0     22995    4.00    3.50    0.00    7.50     1  java
02:44:57 PM     0     23112    0.50    0.00    0.00    0.50     1  supervisord
02:44:57 PM   101     23264    2.00    2.00    0.00    4.00     1  beam.smp
02:44:57 PM   105     24078    1.00    1.00    0.00    2.00     1  mysqld
02:44:57 PM     0     26109    0.00    0.50    0.00    0.50     0  java
02:44:57 PM     0     27157    1.00    0.00    0.00    1.00     2  java
02:44:57 PM     0     30423    1.50    0.00    0.00    1.50     0  java
```
## iostat -xz 1
iostat 较好的反映IO密集型应用的负载情况。
```
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          61.22    0.00    5.58    0.06    0.00   33.15

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     6.00    0.00   13.00     0.00  1364.00   209.85     0.03    2.00    0.00    2.00   0.77   1.00
```
r/s, w/s, rkB/s, wkB/s: 顾名思义，分别表示每秒钟读、写的次数和读写的kB数。

await: 是IO的平均时间，单位为ms。这个过大的话表明设备负载饱和了，或者设备有故障。

avgqu-sz: 是对设备的平均请求数，大于1的话表明有一定的饱和了。

%util：用时的百分比。表示没秒钟有多少时间花在了IO上。一般这个超过60%说明IO性能有问题了。

针对IO的优化需要做到IO的异步处理即可。使得应用不直接阻塞在慢响应上面。适用的技术：提前读、写缓存。

## free -m
free命令用于展示系统内存的使用情况：
```
root@c3e0fff4c337:/var/eshop/logs# free -m
             total       used       free     shared    buffers     cached
Mem:         16048       6919       9129         38          1       3522
-/+ buffers/cache:       3394      12654
Swap:         1905          0       1905
```
需要注意的是cache 的memory也应该算到free里面。

## sar -n DEV 1
用于监控网卡的传输性能，确定是否带宽已经达到极限。
```
03:18:51 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
03:18:53 PM vethc4d02c4   2353.50   1888.00    643.56   2374.00      0.00      0.00      0.00      1.38
03:18:53 PM veth3cbedaf      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
03:18:53 PM      eth0   4051.50   3223.50   3217.26    992.07      0.00      0.00      0.00      2.64
03:18:53 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
03:18:53 PM   docker0   2353.50   1888.00    611.39   2374.00      0.00      0.00      0.00      0.00

03:18:53 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
03:18:55 PM vethc4d02c4   1913.50   1504.00    598.69   1829.92      0.00      0.00      0.00      1.06
03:18:55 PM veth3cbedaf      0.50      0.50      0.03      0.04      0.00      0.00      0.00      0.00
03:18:55 PM      eth0   3386.00   2698.50   2738.93    946.30      0.00      0.00      0.00      2.24
03:18:55 PM        lo     48.00     48.00      2.34      2.34      0.00      0.00      0.00      0.00
03:18:55 PM   docker0   1914.00   1504.50    572.56   1829.95      0.00      0.00      0.00      0.00
```
通过rxkB/s和txkB/s可以得到网卡的负载情况。并可以确认是否已经超过带宽上限了。

## sar -n TCP,ETCP 1
sar是个比较复杂的命令，有多种使用方式，上面的信息也是基于这个命令。要获得TCP相关的统计信息这个命令就格外重要了。
```
06:38:32 PM  active/s passive/s    iseg/s    oseg/s
06:38:33 PM      0.00      0.00     11.64      9.59

06:38:32 PM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s
06:38:33 PM      0.00      0.00      0.00      0.00      0.00

Average:     active/s passive/s    iseg/s    oseg/s
Average:         0.15      0.15     21.67     22.88

Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
Average:         0.00      0.05      0.00      0.00      0.25
```
active/s: 每秒钟发起的TCP链接数，例如通过connect()调用的方式；
passive/s：每秒钟远程发起的TCP链接数，例如通过accept()调用建立的链接。
retrans/s：每秒钟TCP重传的数量。这个如果过高的话说明网络状况较差。这个是比较粗略的统计。

## top
top 命令是使用比较频繁的。内存、CPU、进程还有每个核的CPU使用情况都能一目了然。
```
top - 18:58:23 up 256 days, 29 min,  4 users,  load average: 18.54, 42.49, 37.05
Tasks: 247 total,   7 running, 239 sleeping,   0 stopped,   1 zombie
%Cpu0  : 74.1 us,  4.7 sy,  0.0 ni, 20.9 id,  0.0 wa,  0.3 hi,  0.0 si,  0.0 st
%Cpu1  : 74.5 us,  4.6 sy,  0.0 ni, 20.2 id,  0.0 wa,  0.7 hi,  0.0 si,  0.0 st
%Cpu2  : 67.5 us,  7.0 sy,  0.0 ni, 16.6 id,  0.0 wa,  8.9 hi,  0.0 si,  0.0 st
%Cpu3  : 69.9 us,  4.0 sy,  0.0 ni, 25.5 id,  0.0 wa,  0.7 hi,  0.0 si,  0.0 st
%Cpu4  : 70.8 us,  4.7 sy,  0.0 ni, 23.9 id,  0.0 wa,  0.7 hi,  0.0 si,  0.0 st
%Cpu5  : 67.9 us,  4.3 sy,  0.0 ni, 27.2 id,  0.0 wa,  0.7 hi,  0.0 si,  0.0 st
%Cpu6  : 71.9 us,  5.0 sy,  0.0 ni, 22.5 id,  0.0 wa,  0.7 hi,  0.0 si,  0.0 st
%Cpu7  : 64.9 us,  4.6 sy,  0.0 ni, 29.8 id,  0.3 wa,  0.3 hi,  0.0 si,  0.0 st
KiB Mem:  16433764 total,  5466784 used, 10966980 free,     1820 buffers
KiB Swap:  1951740 total,        0 used,  1951740 free.  3726664 cached Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
31418 www-data  20   0  500672  55144  31024 R  25.9  0.3   0:05.90 apache2
29182 www-data  20   0  500196  54780  31060 R  21.9  0.3   0:13.48 apache2
31450 www-data  20   0  499616  54304  30924 S  20.9  0.3   0:02.93 apache2
31384 www-data  20   0  498880  54072  31032 S  20.6  0.3   0:05.99 apache2
29066 www-data  20   0  498652  53944  31116 S  20.2  0.3   0:17.17 apache2
29267 www-data  20   0  493040  48260  31040 S  20.2  0.3   0:15.48 apache2
28780 www-data  20   0  498372  53604  31060 S  19.9  0.3   0:28.09 apache2
```
Ctrl+S 能让其先停止更新，Ctrl+Q让其继续执行。

## 总结
系统性能涉及很多的方面，遇到性能问题还是最好有个系统的方法，逐一解决每个问题。不然到了最后一团浆糊，还弄不清楚该优化那里。针对系统的性能优化需要一些经验的积累，慢慢就能轻车熟路，就像修车师父一样，老师父总能让人更放心些。
所以呢，这种事情不能急，还是慢慢来吧。多总结、多实践、多解决些问题，就会水到渠成了。
